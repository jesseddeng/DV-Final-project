<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.min.css">
    <meta charset="utf-8">
    <style>
        body {
            background-color: whitesmoke;
        }

        :root {
            --line-chart-color: #89a6b4;
            --annotation-context-color2: #35f164e5;
            --annotation-context-color3: #ff2f2f;
            --annotation-context-color: #eeff00;
            --annotation-above-color: #00BFA5;
            --annotation-anomaly-color: #E8336D;
        }

        svg {
            background-color: rgb(36, 35, 35);
            font-family: 'Lato';
        }

        .axis,
        .axis text {
            fill: var(--line-chart-color);
        }

        .axis line,
        path {
            stroke: var(--line-chart-color);
        }

        path {
            fill: none;
        }


        .annotation:not(.above):not(.anomaly) path {
            stroke-dasharray: 1, 3;
        }

        .annotation text {
            fill: var(--annotation-context-color);
        }

        .annotation.second text {
            fill: var(--annotation-context-color2);
        }

        .annotation.third text {
            fill: var(--annotation-context-color3);
        }

        .annotation.above path {
            stroke: var(--annotation-above-color);
        }

        .annotation.above text {
            fill: var(--annotation-above-color);
        }

        .annotation.anomaly path {
            stroke: var(--annotation-anomaly-color);
            stroke-width: 2px;
        }

        .annotation.anomaly text {
            fill: var(--annotation-anomaly-color);
        }

        .annotation-note-bg {
            fill: rgba(0, 0, 0, 0);
        }

        .annotation-note-title {
            font-weight: bold;
        }

        text.title {
            font-size: 1.2em;
            font-weight: bold;
        }

        h1 {
            font-size: 2em;
            margin: 0.67em 0;
        }
        h2 {
            font-size: 1.5em;
            margin: 0.67em 0;
        }
    </style>
</head>

<body>
    <div class="container ">


        <h1>Summer 2020 Data Visualization Final Project  - Jesse Deng</h1>
        <p>This narrative visualization shows the stock trending of BP's stock in 30 yeats.Also Analyzing the trending
            with different events happened before and now.
            I chose BP becasue BP is the company I working for right now. </p>
        <nav>
            <ul class="pagination">

                <li class="page-item active" id='1'>
                    <a class="page-link" id='1-1' href="#">Price Trending</a></li>
                <li class="page-item" id='2'>
                    <a class="page-link" id='2-1' href="#">High price Analysis</a>
                </li>
                <li class="page-item" id='3'>
                    <a class="page-link" id='3-1' href="#">Low price Analysis</a></li>

            </ul>
        </nav>

        <div id="graph" class="d-flex flex-column"></div>
        <h2 id="text">Price Trending</h2>
        <p id="p">This animation shows the trending of BP stocks in these 30 years. It shows that BP's stock seems has a very changing curve.
            The lowest price was $10.34 which make sense before 2000. However, the stock price down to the level almost 20 years ago in 2020. 
            From 2004 to 2008, the stock price higher than before and after. The highers price of it was $79.7 which doesnt shows in the futunre again.</p>
    </div>

    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.12.1/d3-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.0.4/popper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>

    <script>

        const width = 960
        const height = 500
        const margin = { top: 180, bottom: 50, left: 50, right: 50 }

        const x = d3.scaleTime().range([margin.left, width - margin.right])
            .domain([new Date('1/1/1990'), new Date('7/15/2020')])
        const y = d3.scaleLinear().range([height - margin.bottom, margin.top])
            .domain([0, 80])

        d3.csv("BP.csv", function (error, d) {
            if (error) throw error;
            var initialGraph = function (data,status) {

                var line = d3.line()
                    .x(function (d) { return x(new Date(d.Date)) })
                    .y(function (d) { return y(d.Close) })

                /* --- creating line using divided line code --- */
                if (status==1){ var dLineData = dividedLine(s1, data, 20);}
                if (status==2){ var dLineData = dividedLine(s2, data, 20);}
                if (status==3){ var dLineData = dividedLine(s3, data, 20);}


                const svg = d3.select("#graph")
                    .append("svg")
                    .style("width", 960)
                    .style("height", 500)


                svg.append('g')
                    .attr('class', 'lineChart')

                svg.select("g.lineChart")
                    .selectAll("path.segment")
                    .data(dLineData)
                    .enter()
                    .append("path")
                    .attr("d", function (d) {
                        return line(d.points)
                    })
                    .each(function (d){
                    const styles = styleMap[d.key]
                    Object.keys(styles).forEach(function(k){
                    d3.select(this)
                        .style(k, styles[k])
                    }, this)
                })

                svg.append('g')
                    .attr('class', 'line')

                svg.append('g')
                    .attr('class', 'line2')





                const yAxis = d3.axisLeft(y).ticks(3).tickFormat(function (d) { return "$" + d })
                const xAxis = d3.axisBottom(x)
                svg.append("g")
                    .attr("class", "axis y")
                    .attr("transform", "translate(" + margin.left + ", 0)")
                    .call(yAxis);

                svg.append("g")
                    .attr("class", "axis x")
                    .attr("transform", "translate(0," + (height - margin.bottom) + ")")
                    .call(xAxis);




            };




            initialGraph(d,1);



            animatelines(0);
            document.getElementById("2-1").addEventListener("click", function () {
                d3.select("svg").remove();
                initialGraph(d,2);

                document.getElementById('2').className = "page-item active";
                document.getElementById('1').className = "page-item ";
                document.getElementById('3').className = "page-item ";
                document.getElementById("text").innerText = "High price Analysis";
                document.getElementById("p").innerText =
                 "The green line of the chart shows when the price is higher than 50. There have 3 sections above $50, "+
                 "the first section is around 1999. In 1999, Bp and Amoco complete their $53 billion merger which cause the stock price up to $50 at the first time. "+
                 "In 2003, the energy crisis also caused BP stock price higher than before, aboving $60 which nerver showing again in the future. After the Financial crisis of 2007–2008, the BP stock price"+
                 " back to $50 agian. ";

                /* Code below relevant for annotations */
                const annotations = [{
                    note: { label: "BP and Amoco Merge", wrap: 100 },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "1/1/1999" } //position the x based on an x scale
                },

                {
                    note: { label: "2003 energy crisis" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "1/1/2003" }
                },

                {
                    note: { label: "Above $50", wrap: 100, },
                    className: "above",
                    disable: ["connector"],
                    subject: {
                        x1: x(new Date('5/7/1999')),
                        x2: x(new Date('8/12/2002'))
                    },
                    x: x(new Date('5/7/1999')),
                    dx: -50,
                    data: { y: 50 }
                },

                {
                    note: { label: "Above $60", wrap: 100, },
                    className: "above",
                    disable: ["connector"],
                    subject: {
                        x1: x(new Date('4/21/2005')),
                        x2: x(new Date('8/11/2008')),
                    },
                    x: x(new Date('4/21/2005')),
                    dx: -50,
                    data: { y: 60 }
                }

                ]

                const type = d3.annotationCustomType(
                    d3.annotationXYThreshold,
                    {
                        "note": {
                            "lineType": "none",
                            "orientation": "top",
                            "align": "middle"
                        }
                    }
                )

                const makeAnnotations = d3.annotation()
                    .type(type)
                    //Gives you access to any data objects in the annotations array
                    .accessors({
                        x: function (d) { return x(new Date(d.x)) },
                        y: function (d) { return y(d.y) }
                    })
                    .annotations(annotations)
                    .textWrap(30)

                d3.select("svg")
                    .append("g")
                    .attr("class", "annotation-group")
                    .call(makeAnnotations)

            });
            document.getElementById("3-1").addEventListener("click", function () {

                d3.select("svg").remove();
                initialGraph(d,3);

                document.getElementById('3').className = "page-item active";
                document.getElementById('2').className = "page-item ";
                document.getElementById('1').className = "page-item ";
                document.getElementById("text").innerText = "Low price Analysis";
                document.getElementById("p").innerText =
                 "The red line of the chart shows when the price is lower than 40. Except the time before 2000, there have 3 main sections above $40. "+
                 "First section is around 2007 and 2008. The stock price dropped down to $34.54 because of it. "+
                 "After that, Deepwater Horizon oil spill happened and it influenced BP stock price dropped to $27. After that it seems back to normal for a while. However, court has adjudged that "+
                 " BP need to pay $20 billion to settle claims in 2014 . It makes BP need to sell some business to meet these costs, and the stock price dropped lower than $40. In 2020, BP face the biggest trouble"
                 +" than before that Russia–Saudi Arabia oil price war and coronavirus together caused the stock price back to 1990s level."+
                 " It seems that it wont back to $30 this year because the oil war still not end and BP also decided to layoff 10,000 empolee to overcome this difficulties.";

                /* Code below relevant for annotations */
                const annotations = [{
                    note: { label: "Financial crisis" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "8/9/2007" } //position the x based on an x scale
                },
                {
                    note: { label: "Deepwater Horizon oil spill" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "4/20/2010" }
                },
                {
                    note: { label: "Deepwater Horizon oil spill" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "4/20/2010" }
                },{
                    note: { label: "Start to sell some business" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "1/1/2015" }
                },
                {
                    note: { label: "Russia–Saudi Arabia oil price war" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "3/8/2020" }
                },
                {
                    note: {
                        label: "Lowest here: $34.54",
                        lineType: "none",
                        orientation: "leftRight",
                        "align": "middle"
                    },
                    className: "anomaly",
                    type: d3.annotationCalloutCircle,
                    subject: { radius: 15 },
                    data: { x: "3/5/2009", y: 34.54 },
                    dx: -53
                }, {
                    note: {
                        label: "Lowest here: $27.05",
                        lineType: "none",
                        orientation: "leftRight",
                        "align": "middle"
                    },
                    className: "anomaly",
                    type: d3.annotationCalloutCircle,
                    subject: { radius: 15 },
                    data: { x: "6/28/2010", y: 27.05 },
                    dx: 53
                }, {
                    note: {
                        label: "Lowest here: $16.11",
                        lineType: "none",
                        orientation: "leftRight",
                        "align": "middle"
                    },
                    className: "anomaly",
                    type: d3.annotationCalloutCircle,
                    subject: { radius: 15 },
                    data: { x: "3/18/2020", y: 16.11 },
                    dx: -53
                }

                ]

                const type = d3.annotationCustomType(
                    d3.annotationXYThreshold,
                    {
                        "note": {
                            "lineType": "none",
                            "orientation": "top",
                            "align": "middle"
                        }
                    }
                )

                const makeAnnotations = d3.annotation()
                    .type(type)
                    //Gives you access to any data objects in the annotations array
                    .accessors({
                        x: function (d) { return x(new Date(d.x)) },
                        y: function (d) { return y(d.y) }
                    })
                    .annotations(annotations)
                    .textWrap(30)

                d3.select("svg")
                    .append("g")
                    .attr("class", "annotation-group")
                    .call(makeAnnotations)

            });

            document.getElementById("1-1").addEventListener("click", function () {
                d3.select("svg").remove();
                initialGraph(d,1);
                d3.selectAll(".lineChart").style("opacity", "0");
                animatelines(0);
                document.getElementById('3').className = "page-item ";
                document.getElementById('2').className = "page-item ";
                document.getElementById('1').className = "page-item active";
                document.getElementById("text").innerText = "Price Trending";
                document.getElementById("p").innerText =
                 "This animation shows the trending of BP stocks in these 30 years. It shows that BP's stock seems has a very changing curve.The lowest price was"+
                 " $10.34 which make sense before 2000. However, the stock price down to the level almost 20 years ago in 2020."+
                 "From 2004 to 2008, the stock price higher than before and after. The highers price of it was $79.7 which doesnt shows in the futunre again.";




            });


        }
        );

        function animatelines(whichline) {

            // Look at what button was clicked
            if (whichline == 0) {


                // First set all the lines to be invisible
                d3.selectAll(".lineChart").style("opacity", "0");

                d3.select(".lineChart").style("opacity", "1").style("stroke-width", 1);

                d3.selectAll(".lineChart")
                    .attr("stroke-dasharray", 21000 + " " + 21000)
                    .attr("stroke-dashoffset", 21000)
                    .transition()
                    .duration(5000)
                    .ease(d3.easeQuad)
                    .attr("stroke-dashoffset", 0);

                d3.select("g.line")
                    .append("line")
                    .attr("x1", x(new Date('1/1/1990')))
                    .attr("y1", y(80))
                    .attr("x2", x(new Date('7/15/2020')))
                    .attr("y2", y(80))
                    .attr("style", "stroke:#35f164e5;stroke-width:1;'")
                    .attr("stroke-dasharray", 5 + " " + 5)
                    .attr("stroke-dashoffset", 1000)
                    .transition()
                    .duration(1000)
                    .ease(d3.easeQuad)
                    .attr("stroke-dashoffset", 0);

                d3.select("g.line2")
                    .append("line")
                    .attr("x1", x(new Date('1/1/1990')))
                    .attr("y1", y(10.34))
                    .attr("x2", x(new Date('7/15/2020')))
                    .attr("y2", y(10.34))
                    .attr("style", "stroke:#ff2f2f;stroke-width:1;'")
                    .attr("stroke-dasharray", 5 + " " + 5)
                    .attr("stroke-dashoffset", 1000)
                    .transition()
                    .duration(1000)
                    .ease(d3.easeQuad) //Try linear, quad, bounce... see other examples here - http://bl.ocks.org/hunzy/9929724
                    .attr("stroke-dashoffset", 0);



                const annotations = [{
                    note: { label: "Highest Price: $79.7", wrap: 150 },
                    className: "second",

                    y: margin.top,
                    data: { x: "11/16/2007" } //position the x based on an x scale
                }, {
                    note: { label: "Lowest Price: $10.34", wrap: 150 },
                    className: "third",


                    data: { x: "11/4/1992", y: 3.34 } //position the x based on an x scale
                },

                {
                    note: { label: "Price Now: $23.28" },
                    subject: {
                        y1: margin.top,
                        y2: height - margin.bottom
                    },
                    y: margin.top,
                    data: { x: "7/14/2020" }
                }


                ]

                const type = d3.annotationCustomType(
                    d3.annotationXYThreshold,
                    {
                        "note": {
                            "lineType": "none",
                            "orientation": "top",
                            "align": "middle"
                        }
                    }
                )

                const makeAnnotations = d3.annotation()
                    .type(type)
                    //Gives you access to any data objects in the annotations array
                    .accessors({
                        x: function (d) { return x(new Date(d.x)) },
                        y: function (d) { return y(d.y) }
                    })
                    .annotations(annotations)
                    .textWrap(30)

                d3.select("svg")
                    .append("g")
                    .attr("class", "annotation-group")
                    .call(makeAnnotations)

            }

        }


    </script>
    <script>
        const dividedLine = (parameters, points, searchIterations) => {
            let currentParameters = parameters(points[0], 0)
            let currentPointsArray = []
            let dividedLinesData = [{ key: currentParameters, points: currentPointsArray }]
            points.forEach((point, pointI) => {

                const newParameters = parameters(point, pointI)
                let matchingParams = newParameters === currentParameters;

                if (typeof currentParameters === "object") {
                    matchingParams = JSON.stringify(newParameters) === JSON.stringify(currentParameters)
                }

                if (matchingParams) {
                    currentPointsArray.push(point)
                } else {
                    const lastPoint = currentPointsArray[currentPointsArray.length - 1];
                    let pointA = lastPoint;
                    let pointB = point;

                    for (let x = 0; x < searchIterations; x++) {
                        const keys = Object.keys(pointA)
                        const findPoints = simpleSearchFunction(pointA, pointB, currentParameters, parameters, keys)
                        pointA = findPoints[0]
                        pointB = findPoints[1]
                    }
                    currentPointsArray.push(pointB)
                    currentPointsArray = [pointB, point]
                    dividedLinesData.push({ key: newParameters, points: currentPointsArray })
                    currentParameters = newParameters
                }
            })
            return dividedLinesData
        }

        function simpleSearchFunction(pointA, pointB, current, parameters, keys) {
            const betweenPoint = {};
            keys.forEach(key => {
                betweenPoint[key] = typeof pointA[key] === "number" ? (pointA[key] + pointB[key]) / 2 : pointB[key]
            })

            if (JSON.stringify(parameters(betweenPoint)) === JSON.stringify(current)) {
                return [betweenPoint, pointB]
            }
            return [pointA, betweenPoint]
        }

        function s2(point) {

            if (point.Close > 50) {
                return "top"
            }
            return "normal"
        }
        
        function s3(point) {

            if (point.Close < 40) {
                return "low"
            }
            return "normal"
        }
        function s1(point) {
            return "normal"
        }
        

        var styleMap = {

            top: { "stroke": "#35f164e5" },
            low: { "stroke": "#ff2f2f" },
            normal: {"stroke": "whitesmoke"}
        }   
    </script>
</body>

</html>